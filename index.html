<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>codex-html-lab • Playground</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#334155; --text:#e5e7eb; --accent:#22d3ee; --border:#1f2937; --ok:#22c55e; --warn:#f59e0b; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0b1220,#0f172a);position:sticky;top:0;z-index:5}
    header h1{font-size:16px;margin:0;letter-spacing:.5px}
    header .badge{font-size:12px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:#94a3b8}
    .container{display:grid;grid-template-columns:480px 1fr;height:calc(100% - 52px)} .left,.right{height:100%;overflow:auto}
    .left{border-right:1px solid var(--border);background:var(--panel)} .section{padding:12px 14px;border-bottom:1px solid var(--border)}
    .section h2{margin:0 0 8px;font-size:13px;color:#cbd5e1;text-transform:uppercase;letter-spacing:.08em}
    textarea,input,select,button{font:inherit} textarea{width:100%;min-height:140px;resize:vertical;padding:10px 12px;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap} .row>*{flex:none} .grow{flex:1 1 auto}
    .btn{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{border-color:var(--muted)} .btn.primary{border-color:var(--accent);color:var(--accent)} .btn.ok{border-color:var(--ok);color:var(--ok)} .btn.warn{border-color:var(--warn);color:var(--warn)}
    .hint{color:#94a3b8;font-size:12px} .list{display:grid;gap:8px} .card{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#0b1220}
    .card h3{margin:0 0 6px;font-size:14px;color:#cbd5e1} .card .meta{font-size:12px;color:#94a3b8}
    .checks{display:grid;gap:6px} .checks label{display:grid;grid-template-columns:18px 1fr;align-items:start;gap:8px}
    .right{display:grid;grid-template-rows:auto auto 1fr}
    .preview-toolbar{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:var(--panel)}
    .preview-wrap{display:grid;grid-template-rows:auto 1fr;min-height:0}
    .preview-head{padding:10px 12px;border-bottom:1px solid var(--border);color:#94a3b8;background:#0b1220;display:flex;justify-content:space-between;align-items:center}
    iframe{width:100%;height:100%;border:0;background:#fff}
    @media (max-width:1000px){.container{grid-template-columns:1fr}.left{border-right:0}}
  </style>
</head>
<body>
  <header>
    <h1>codex-html-lab • Playground</h1>
    <span class="badge">Spec → App</span>
    <span class="hint">左侧写规格/模板；下方粘贴生成的 HTML，右侧沙箱即时预览。</span>
  </header>
  <div class="container">
    <aside class="left">
      <div class="section">
        <h2>规格 / 提示词</h2>
        <div class="row" style="margin-bottom:8px">
          <select id="tplSelect" class="btn">
            <option value="">插入模板…</option>
            <option value="textStats">文本/词数统计器</option>
            <option value="todo">待办清单（localStorage）</option>
            <option value="tableFilter">表格排序与过滤</option>
            <option value="imagePreview">拖拽上传图片预览</option>
          </select>
          <button class="btn" id="insertTpl">插入</button>
          <button class="btn" id="clearSpec">清空</button>
          <span class="grow"></span>
          <input id="specTitle" class="btn" placeholder="规格标题（可选）" style="min-width:160px" />
          <button class="btn" id="saveSpec">保存规格</button>
        </div>
        <textarea id="spec" placeholder="在此编写自然语言规格（功能、技术边界、验收标准等）。"></textarea>
        <div class="hint">以“验收标准：”开头的列表会出现在下方清单中。</div>
      </div>
      <div class="section">
        <h2>生成的 HTML / CSS / JS</h2>
        <div class="row" style="margin-bottom:8px">
          <button class="btn primary" id="render">渲染到右侧</button>
          <button class="btn" id="openNew">在新窗口打开</button>
          <button class="btn ok" id="download">导出为 index.html</button>
          <button class="btn warn" id="clearCode">清空代码</button>
        </div>
        <textarea id="code" placeholder="将 Codex 生成的完整页面代码粘贴到这里（含 <style>/<script> 皆可）。"></textarea>
      </div>
      <div class="section">
        <h2>验收清单（来自规格）</h2>
        <div id="checklist" class="checks hint">暂无条目。</div>
      </div>
      <div class="section">
        <h2>历史记录（最近 5 次）</h2>
        <div id="history" class="list hint">暂无历史。</div>
      </div>
    </aside>
    <main class="right">
      <div class="preview-toolbar">
        <span class="hint">预览区域（iframe，沙箱渲染你的代码）</span>
        <span class="grow"></span>
        <button class="btn" id="resetPreview">重置空白</button>
      </div>
      <div class="preview-wrap">
        <div class="preview-head">
          <div>页面标题：<span id="pageTitle">（未设置）</span></div>
          <div class="hint" id="infoLine">—</div>
        </div>
        <iframe id="preview" sandbox="allow-forms allow-scripts allow-downloads" referrerpolicy="no-referrer"></iframe>
      </div>
    </main>
  </div>
  <script>
    const TEMPLATES = {
      textStats: `你现在是前端生成助手。请在 /apps/playground 下创建一个单文件页面：\n功能：\n1. 输入任意文本，实时统计字数、词数，并显示最近 5 次输入历史。\n2. 提供“导出为 .txt”按钮。\n技术边界：\n- 仅使用原生 HTML/CSS/JS，不引入框架和外部 CDN。\n- 单文件实现，包含 <style> 与 <script>。\n验收标准：\n- [ ] 打开页面即可使用，无构建步骤\n- [ ] 输入区域 400px 高；统计信息随输入变化\n- [ ] 历史记录可清空并持久化在 localStorage\n提交物：单个 index.html 文件，代码含必要注释。`,
      todo: `生成“待办清单”单页：\n功能：增/删/勾选；筛选（全部/未/已）；显示剩余数量；localStorage 持久化。\n技术边界：原生实现；单文件。\n验收：刷新后仍保留；可批量清除已完成；键盘可达。`,
      tableFilter: `生成“表格排序与过滤”：\n搜索输入框；列头排序（升/降）；右上角状态文本；30 条模拟数据；移动端可横向滚动。`,
      imagePreview: `生成“拖拽上传图片并预览”：\n拖拽/点击选择；多图缩略图网格；删除单张；清空全部；FileReader+ObjectURL；不上传后端。`
    };

    const $ = (s,el=document)=>el.querySelector(s), byId=id=>document.getElementById(id);
    const specEl=byId('spec'), codeEl=byId('code'), tplSelect=byId('tplSelect');
    const insertTplBtn=byId('insertTpl'), clearSpecBtn=byId('clearSpec'), saveSpecBtn=byId('saveSpec');
    const specTitleEl=byId('specTitle'), checklistEl=byId('checklist'), historyEl=byId('history');
    const renderBtn=byId('render'), openNewBtn=byId('openNew'), downloadBtn=byId('download'), clearCodeBtn=byId('clearCode');
    const preview=byId('preview'), resetPreviewBtn=byId('resetPreview'), pageTitleEl=byId('pageTitle'), infoLine=byId('infoLine');
    const STORAGE_KEY='codex-html-lab.history.v1';

    const nowStr=()=>{const d=new Date(),p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`}
    const loadHistory=()=>{try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]}}
    const saveHistory=item=>{const list=loadHistory();list.unshift(item);localStorage.setItem(STORAGE_KEY,JSON.stringify(list.slice(0,5)));renderHistory()}
    const escapeHtml=s=>String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))

    function parseChecklistFromSpec(){
      const lines=(specEl.value||'').split(/\n/);const start=lines.findIndex(l=>/^(验收标准|Acceptance Criteria)/i.test(l.trim()));
      let items=[];if(start>=0){for(let i=start+1;i<lines.length;i++){const t=lines[i].trim();if(!t)continue; if(/^[A-Za-z\u4e00-\u9fa5]/.test(t)&&!t.startsWith('-'))break; const m=t.match(/^[-*] \[.\] (.*)$/)||t.match(/^[-*] (.*)$/); if(m)items.push(m[1]);}}
      if(!items.length){checklistEl.innerHTML='<div class="hint">暂无条目。</div>';return}
      checklistEl.innerHTML=''; items.forEach((text,i)=>{const id='ck_'+i+'_'+Math.random().toString(36).slice(2,7); const lab=document.createElement('label'); lab.innerHTML=`<input type="checkbox" id="${id}" /> <span>${escapeHtml(text)}</span>`; checklistEl.appendChild(lab)})
    }

    function renderHistory(){ const list=loadHistory(); if(!list.length){historyEl.innerHTML='<div class="hint">暂无历史。</div>';return} historyEl.innerHTML=''; list.forEach((it,idx)=>{const div=document.createElement('div'); div.className='card'; div.innerHTML=`<h3>${escapeHtml(it.title||'(未命名规格)')}</h3><div class=meta>${escapeHtml(it.time)}</div><div class=row style=margin-top:8px><button class=btn data-act=load data-idx=${idx}>载入</button><button class="btn warn" data-act=del data-idx=${idx}>删除</button></div>`; historyEl.appendChild(div)}) }

    historyEl.addEventListener('click',e=>{const b=e.target.closest('button'); if(!b)return; const act=b.getAttribute('data-act'), idx=+b.getAttribute('data-idx'); const list=loadHistory(); if(act==='load'){const it=list[idx]; specEl.value=it.spec||''; codeEl.value=it.code||''; specTitleEl.value=it.title||''; parseChecklistFromSpec()} else if(act==='del'){list.splice(idx,1); localStorage.setItem(STORAGE_KEY,JSON.stringify(list)); renderHistory()}})

    insertTplBtn.addEventListener('click',()=>{const key=tplSelect.value; if(!key)return; specEl.value=TEMPLATES[key]; parseChecklistFromSpec()})
    clearSpecBtn.addEventListener('click',()=>{specEl.value=''; parseChecklistFromSpec()})
    saveSpecBtn.addEventListener('click',()=>{saveHistory({title:(specTitleEl.value||'(未命名规格)').trim(), spec:specEl.value, code:codeEl.value, time:nowStr()})})
    specEl.addEventListener('input',parseChecklistFromSpec)

    function renderToIframe(html){ const doc=preview.contentDocument||preview.contentWindow?.document; if(!doc)return; doc.open(); doc.write(html||'<!doctype html><html><head><meta charset="utf-8"><title>空白</title></head><body style="font-family:system-ui;padding:20px;color:#111">空白页面</body></html>'); doc.close(); try{pageTitleEl.textContent=doc.title||'（未设置）'}catch{pageTitleEl.textContent='（未设置）'} infoLine.textContent=`渲染于 ${nowStr()}` }
    renderBtn.addEventListener('click',()=>{const html=codeEl.value.trim(); if(!html){alert('请先粘贴生成的 HTML 代码'); return} renderToIframe(html)})
    resetPreviewBtn.addEventListener('click',()=>renderToIframe(''))
    openNewBtn.addEventListener('click',()=>{const html=codeEl.value.trim(); if(!html){alert('请先粘贴生成的 HTML 代码'); return} const blob=new Blob([html],{type:'text/html'}); const url=URL.createObjectURL(blob); window.open(url,'_blank'); setTimeout(()=>URL.revokeObjectURL(url),10000)})
    downloadBtn.addEventListener('click',()=>{const html=codeEl.value.trim(); if(!html){alert('请先粘贴生成的 HTML 代码'); return} const a=document.createElement('a'); a.download='index.html'; a.href=URL.createObjectURL(new Blob([html],{type:'text/html'})); document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove()},0)})
    clearCodeBtn.addEventListener('click',()=>codeEl.value='')

    renderHistory(); parseChecklistFromSpec(); renderToIframe('')
  </script>
</body>
</html>
